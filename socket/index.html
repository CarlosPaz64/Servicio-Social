<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretaría de Bienestar | Gobierno | Yucatán</title>
    <link rel="stylesheet" href="/stylesSocket.css">
    <link rel="icon" href="logo.png" type="image/x-icon">
</head>
<body>
    <div class="table-users">
        <div class="header">Trámites verificación</div>
        
        <table cellspacing="0">
           <thead>
               <tr>
                  <th>Folio</th>
                  <th>ID único</th>
                  <th>CURP</th>
                  <th>Nombre completo</th>
                  <th>Trámite realizado</th>
                  <th>Comentario</th>
               </tr>
           </thead>
           <tbody id="tramitesTable">
               <!-- Los datos se insertarán aquí -->
           </tbody>
        </table>
     </div>

     <!-- Inclusón del cliente de Socket.io -->
     <script src="/socket.io/socket.io.js"></script>
     <script>
         const socket = io();
         let registroCount = 0;
         let pageCount = 1;

         // Pedido de permisos para las notificaciones
         if (Notification.permission !== "granted") {
             Notification.requestPermission();
         }

         // Función para mostrar notificación
         function showNotification(tramite) {
             if (Notification.permission === "granted") {
                 const notification = new Notification("¡Se ha subido un nuevo registro!", {
                     body: `Folio: ${tramite.num_folio}, Nombre: ${tramite.fullname}`,
                     icon: `C:\Users\Usuario1-Servicio\Documents\Servicio Social\public\logo.png`
                 });
             }
         }

         // Función para agregar un registro a la tabla
         function addRowToTable(tramite) {
             registroCount++;

             if (registroCount > 10 * pageCount) {
                 pageCount++;
                 registroCount = 1;
                 // Crea una nueva tabla o página
                 const newPage = document.createElement('div');
                 newPage.classList.add('table-users');
                 newPage.innerHTML = `
                     <div class="header">Trámites Verificación - Página ${pageCount}</div>
                     <table cellspacing="0">
                         <thead>
                             <tr>
                                <th>Folio</th>
                                <th>ID Único</th>
                                <th>CURP</th>
                                <th>Nombre Completo</th>
                                <th>Trámite</th>
                                <th>Comentario</th>
                             </tr>
                         </thead>
                         <tbody id="tramitesTable${pageCount}">
                         </tbody>
                     </table>
                 `;
                 document.body.appendChild(newPage);
             }

             const tramitesTable = document.getElementById(`tramitesTable${pageCount}`) || document.getElementById('tramitesTable');
             const row = document.createElement('tr');
             row.innerHTML = `
                 <td>${tramite.num_folio}</td>
                 <td>${tramite.id_unico}</td>
                 <td>${tramite.curp}</td>
                 <td>${tramite.fullname}</td>
                 <td>${tramite.tramite}</td>
                 <td>${tramite.comentario}</td>
             `;
             tramitesTable.appendChild(row);
         }

         // Cargar todos los registros actuales al iniciar
         fetch('/formularioEstatus/api/tramites')
             .then(response => response.json())
             .then(data => {
                 data.forEach(tramite => {
                     addRowToTable(tramite);
                 });
             })
             .catch(error => console.error('Error al cargar los trámites:', error));

         // Recibir un nuevo registro del servidor
         socket.on('newRecord', (tramite) => {
             addRowToTable(tramite);
             showNotification(tramite);
         });
     </script>
</body>
</html>
